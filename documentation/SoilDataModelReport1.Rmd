---
title: "Review of current soil data models"
author: "L Heran, K Frederick, M Younger, K Todd-Brown (ktoddbrown@ufl.edu)"
date: "5/1/2020"
output: 
  html_document: 
    toc: yes
bibliography: references.bib
---


```{r globalKnit, include=FALSE}
knitr::opts_chunk$set(echo=FALSE,
                      message=FALSE,
                      warning=FALSE)
```

```{r setup}
library(datamodelr)
library(DT)
library(plyr)
library(tidyverse)
```

```{r readInData}
dataModelDescription <- read_csv(file = '../data/DatasetVariableTable.csv') %>%
  filter(Dataset_ID %in% c("ISCN3", "CCRCN", "Crowther", "vanGestel", "ISRaD" )) %>%
  select(Dataset_ID, Table, Info_type, Info, Variable, Type)  %>%
  mutate(long_table_name = sprintf('%s:%s', Dataset_ID, Table))

##read in the column information
allDataModels <- read_csv(file ='../data/studyDescription.csv') %>%
  filter(!is.na(study_name), !grepl("Holmqu", study_name)) %>%
  select(study_name, table_name, column_name, long_description, unit)
  

##read in the thesorus
#commonVocab <- read_csv(file ='../data/comparitiveColumnNames.csv') %>%
#  select(`new name`, vanGestel, Crowther, CCRCN, ISCN3, ISRaD) %>%
#  filter(!is.na(`new name`), any(!(is.na(vanGestel) | is.na(Crowther) | is.na(CCRCN) |is.na(ISCN3) | is.na(ISRaD))))
```

```{r clean}
dataModels_segments <- dlply(dataModelDescription, c('Dataset_ID'),
                             function(xx){as.list(unique(xx$long_table_name))})

all_models <- dataModelDescription %>%
  filter(Info_type == 'column') %>%
  filter(Dataset_ID %in% c('ISRaD', 'ISCN3', 'CCRCN', 'Crowther', 'vanGestel')) %>%
  #mutate(Type = if_else(Dataset_ID == 'ISRaD' & grepl('_name$', Info), 'id', 
  #                      Type)) %>%
  mutate(ref = case_when(Dataset_ID == 'ISRaD' & grepl('^entry_name$', Info) ~ 'ISRaD:metadata',
                         Dataset_ID == 'ISRaD' & grepl('^site_name$', Info) ~ 'ISRaD:site',
                         Dataset_ID == 'ISRaD' & grepl('^pro_name$', Info) ~ 'ISRaD:profile',
                         Dataset_ID == 'ISRaD' & grepl('^flx_name$', Info) ~ 'ISRaD:flux',
                         Dataset_ID == 'ISRaD' & grepl('^lyr_name$', Info) ~ 'ISRaD:layer',
                         Dataset_ID == 'ISRaD' & grepl('^ist_name$', Info) ~ 'ISRaD:interstitial',
                         Dataset_ID == 'ISRaD' & grepl('^frc_name$', Info) ~ 'ISRaD:fraction',
                         Dataset_ID == 'ISRaD' & grepl('^inc_name$', Info) ~ 'ISRaD:incubation',
                         #ISCN3
                         #Dataset_ID == 'ISCN3' & grepl('^site_name$', Info) ~ 'ISCN3:site',
                         Dataset_ID == 'ISCN3' & grepl('^profile_name$', Info) ~ 'ISCN3:profile',
                         Dataset_ID == 'ISCN3' & grepl('^layer_name$', Info) ~ 'ISCN3:layer',
                         #Dataset_ID == 'ISCN3' & grepl('^fraction_name$', Info) ~ 'ISCN3:fraction',
                         #CCRCN
                         Dataset_ID == 'CCRCN' & grepl('^study_id$', Info) ~ 'CCRCN:Study Information',
                         Dataset_ID == 'CCRCN' & grepl('^site_id$', Info) ~ 'CCRCN:Site Level',
                         Dataset_ID == 'CCRCN' & grepl('^core_id$', Info) ~ 'CCRCN:Core Level',
                         #Crowther
                         Dataset_ID == 'Crowther' & grepl('^Study$', Info) ~ 'Crowther:Summary',
                         Dataset_ID == 'Crowther' & grepl('Row Labels', Info) ~ 'Crowther:Summary',
                         #VanGestel
                         Dataset_ID == 'vanGestel' & grepl('site.id', Info) ~ 'vanGestel:sites',
                         TRUE ~ as.character(NA))) %>%
  mutate( key = !is.na(ref) & Type == 'id') %>%
  mutate(ref_col = case_when(Type == 'id' & (!is.na(ref)) ~ Info,
                             TRUE ~ as.character(NA))) %>%
  rename('column' = 'Info' , 'table' = 'long_table_name' ) %>%
  select(table, column, key, ref, ref_col) %>%
  mutate(ref = if_else(table == ref, as.character(NA), ref),
         ref_col = if_else(is.na(ref), ref, ref_col))


# temp_dm <- as.data_model(all_models %>% filter(key))
# temp_dm2 <- dm_set_segment(temp_dm, dataModels_segments)
# graph <- dm_create_graph(temp_dm2, rankdir = "RL", col_attr = c('column'))
# dm_render_graph(graph)
```



# Introduction and goals

The overall goal of the is to develop, implement, and test best practices for compiling transparent, reproducible, harmonized, and extendable data collections for meta-analysis. 
For this first deliverable we will examine five current meta-analysis efforts in the soil community and compare the ontologies used in these studies to existing ontologies. Subsequent deliveribles will include identify the strengths and weaknesses of the approaches used by the individual projects through one-on-one interviews with the PIs and developers as well as a broader community surveys. Based on these interviews we will suggested best practices based on our findings. Then use best practices to prioritize ongoing development of the Soil Organic Carbon Data Rescue and Harmonization (SOC-DRaH), an open community project started by the International Soil Carbon Network (ISCN). The results from this project would provide a solid basis for seeking future funding to benchmark soil carbon dynamics in Earth system models, generate soil maps, and gap fill missing data using machine learning algorithms.

We considered five data products in this section that were selected for their relevance to research driven soil carbon data products: International Soil Carbon Network vs 3 (ISCN), Coastal Carbon Research Coordination Network (CCRCN), International Soil Radiocarbon Database (ISRaD), and two soil warming meta-analysis conducted by Crowther (@Crowther2016) and vanGestel (@vanGestel2018).  These studies include ongoing studies (CCRCN, ISCN), ongoing with incremental publications (ISRaD:@Lawrence2020) and completed projects (Crowther:@Crowther2016, vanGestel:@vanGestel2018).

# The Ecosytem Ontology most relevant. 

In general The Ecosytem Ontology (http://bioportal.bioontology.org/ontologies/ECSO) was the most relevant ontology to this study. However the control vocabulary was not as method specific as many of the larger data products examined here. We searched http://bioportal.bioontology.org/ for ontologies with four common terms across the studies:  *'soil bulk density'*, *'soil organic carbon'*, *'soil pH'*, and *'soil depth'*. None of the data products considered in this study used a formal, community ontology and instead choose to develope their own or adapt and extend previous data products. We would encourage the adaptation and extention of The Ecosystem Ontology in future studies.

*'soil bulk density'* returned 39 ontology matches (search date: 19 May 2020) many of these were entries for generalized 'density' or 'bulk density'. The Ecosystem Ontology was the only ontlogy with a complete match (http://purl.dataone.org/odo/ECSO_00001110), however the definition of this entry was ambiguous. It did not specify if the bulk density was sieved or dry soil making this challenging to use in a soil study without further specifications.

*'soil organic carbon'* returned 26 ontology matches (search date: 19 May 2020) many of these refered to soil or carbon independently of soil, two entries were specific to soil organic carbon.
Interlinking Ontology for Biological Concepts had a complet match to 'soil organic carbon' (http://purl.jp/bio/4/id/200906061124670034), no units were specified making it ambigous whether this was a mass fraction or density quantification. The Ecosystem Ontology also had a complete match under 'organic carbon percentage in soil' (http://purl.dataone.org/odo/ECSO_00000648) but also had 'total organic carbon percentage' (http://purl.dataone.org/odo/ECSO_00002149), while the units in this case were well defined, the method of measurement, simular to bulk density, needed more specificisity to make the label broadly applicable.

*'soil pH'* returned 43 ontology matches (search data: 19 May 2020), these hits were dominated by either 'soil' or 'pH' hits. Only two ontologies had specific soil pH entries. The Ecosystem Ontology 'soil pH' (http://purl.dataone.org/odo/ECSO_00001646) without an extration method specified. Interlinking Ontology for Biological Concepts 'soil acidity' (http://purl.jp/bio/4/id/200906080708260606), also without an extraction method specified.

*'soil depth'* returned 33 ontology matches (search date: 19 May 2020), only two of this hits specifically refered to depth of soil. The Ecosystem Ontology 'Soil Depth' (http://purl.dataone.org/odo/ECSO_00001207) specifically mentioned soil depth in the context of layers. Interlinking Ontology for Biological Concepts 'soil depth' (http://purl.jp/bio/4/id/201006028017141570), seemed to refer more to the total depth of the soil. 

# Individual PI studies were smaller.

```{r tableCounts}
dataModelDescription %>% select(Dataset_ID, Table, Type, Info, Info_type, Variable) %>%
  filter(Info_type == 'column') %>%
  unique() %>%
  group_by(Dataset_ID) %>% summarize(`Table count` = length(unique(Table)),
                                     `Variable count` =  length(unique(Variable)),
                                     `Column count` = length(unique(Info))) %>%
  rename('Study ID' = Dataset_ID) %>%
  arrange(`Column count`) %>%
  mutate('Multi PI?' = case_when(`Study ID` %in% c("ISCN3", "ISRaD", "CCRCN") ~ 'Yes',
                                 TRUE ~ 'No')) %>%
  knitr::kable(caption = 'Table 1: The data products varied in the number of data tables that they each contained with Crowther only containing 3 tables and the CCRCN product containing 12. There was a wider variation in the unique variables in each study, from 28 to 221. These were associated with columns that contained data values, units, and other methods notes.')
```

In general individual PI projects had smaller data models (see Table 1).
Multi-PI studies tended to have multiple columns describing the same variable. These extra columns describe methods, units, standard deviations, and other quantifies related to variable.
While Crowther techically had 8 data tables, most of the data was in two main data tables (Figure 1).
vanGestel in contrast had 4 data tables (the smallest number in the study) organized around measurement type and site characterization (Figure 2).
In contrast, multi-PI projects had larger data tables with more complex key-ed references across them (Figure 3).
This also held true for the number of variables in each study.
The single PI studies have between 40 (Crowther) and 56 (vanGestel) unique variable names.
Multi-PI studies in contrast had between 144 (CCRCN) and 351 (ISRaD).


```{r CrowtherDM, fig.cap='Figure 1: Crawther data model.'}
temp_dm <- as.data_model(all_models %>% filter(grepl('Crowther', table)))
temp_dm2 <- dm_set_segment(temp_dm, dataModels_segments)
graph <- dm_create_graph(temp_dm2, rankdir = "RL", col_attr = c('column'))
dm_render_graph(graph)
```

```{r vanGestelDM, fig.cap='Figure 1: vanGestel data model.'}
temp_dm <- as.data_model(all_models %>% filter(grepl('vanGestel', table)))
temp_dm2 <- dm_set_segment(temp_dm, dataModels_segments)
graph <- dm_create_graph(temp_dm2, rankdir = "RL", col_attr = c('column'))
dm_render_graph(graph)
```


```{r allDM, fig.cap='Figure 3: Data models with id keys only.'}

all_dm <- as.data_model(all_models)
all_dm2 <- dm_set_segment(all_dm, dataModels_segments)

graph <- dm_create_graph(all_dm2, rankdir = "RL", col_attr = c('column'), view_type = 'keys_only')
dm_render_graph(graph)
```
# Vocabulary across studies were not obviously harmonizable.

Inital efforts to harmonize the vocabulary across studies showed over 580 unique variables out of 924 total variables across all data models.
Only 5 variables were commonly shared across all data models. 
These variables tended to focus on site location, climate, bulk density, and organic carbon percentage (see Table 2).

```{r commonVariables}
dataModelDescription %>% select(Dataset_ID, Variable) %>%
  unique() %>% group_by(Variable) %>%
  tally(name = 'study_count') %>%
  filter(study_count > 2) %>%
  arrange(-study_count) %>% select(-study_count) %>%
  knitr::kable(caption = 'Table 2: Common variables (>2 data models) across data models. Total variable count is 21.')
```

# Study feature summary

Common across most models are location (latitude-longitude-elevation), observation time, mean annual temperature, and mean annual precipitation, to describe site level characturistics.
Depth of core or layer paired with bulk density, organic carbon percentage, sand, silt, clay, pH, soil texture class, cation_exchange_capacity, and 14C describe soil level characteristics.
Columns for vegitation class notes were common but not directly comparable across the studies.
Bulk density was typically broken into several categories depending on measurement method used.

## Unique features
    
  - CCRCN
    + min/max latitude
    + detailed author information
    + 'one_liner' summary
    + break out bulk density mass/volume
    + many specific isotopes listed (Am241, C14, Cs137, Be7, Pb210, Ra226)
    + X_class is free text or control vocabulary
    + coastal specific vocabulary
      * inundation/salinity
    + anthropgenic impacts
    + core-level vs site latitude/longitude and elevation
  - ISCN3
    + disturbance table
    + high level of site details
      - frost free days, ponding, runoff
    + higher then average number of layer-level info
    + fraction table only shared with ISRaD
  - ISRaD
    + interstitial table
    + flux table
    + incubation table
    + fraction table only shared with ISCN3
    + higher than average number of layer info
      - mineral abundance, mass of element extracted
 - Crowther
    + Author updated data (outside sources)
      - Biome, % Clay, pH, 
    + Detailed soil warming data
      - planned temperatures, control temperatures, mean temperatures
    + Cation exchange capasity reported
    + % Nitrogen reported
    + distinguished between total raw carbon and total carbon
    + Difference between detailed_site_id(New Name) and site_id(Old Name)
  - vanGestel
    + mean depth instead of depth of core and layer
    + carbon, nitrogen, and phosphorus pools above and below ground
    + treatments and information about treatments (mean, standard error, size)
    + 'input' variable
    + soil horizon and percent soil organic matter

# Next steps

All groups in this study have been contacted and most confirmed interest in particpating (communication with vanGestel is pending).
We have draft the intial questions for the long format interviews below and plan to start conducting interviews in May.
By the end of June we expect to have a more general community survey targeted more broadly to the soil science community.

## Interview questions

  1) Why did you start this study?
  2) Describe your workflow for ingesting data sets?
  3) What decisions did you make to arrive at this workflow?
  4) How would someone get a copy of the data in this study?
  5) What would you do differently if you had to start again? What would be the same?

# References
